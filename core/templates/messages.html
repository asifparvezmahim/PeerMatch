{% extends "layout.html" %}
{% load static %}

{% block content %}
<div style="height: calc(100vh - 220px); display: grid; grid-template-columns: 300px 1fr; gap: 0; border-radius: 1.5rem; overflow: hidden;"
    class="glass animate">

    <!-- Sidebar -->
    <div style="border-right: 1px solid var(--glass-border); display: flex; flex-direction: column;">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--glass-border);">
            <h2 style="font-size: 1.1rem;">ðŸ’¬ Messages</h2>
        </div>
        <div style="overflow-y: auto; flex: 1;">
            {% if partners %}
            {% for p in partners %}
            {% if active_user and active_user.id == p.id %}
            <!-- Active styling -->
            <a href="{% url 'conversation' user_id=p.id %}"
                style="display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem; text-decoration: none; transition: var(--transition); background: rgba(0,212,255,0.1); border-left: 3px solid var(--primary-color);">
                {% else %}
                <!-- Inactive styling -->
                <a href="{% url 'conversation' user_id=p.id %}"
                    style="display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem; text-decoration: none; transition: var(--transition); background: transparent; border-left: 3px solid transparent;">
                    {% endif %}
                    <div
                        style="width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; flex-shrink: 0; color: white;">
                        {% if p.profile_pic %}
                        <img src="{{ p.profile_pic.url }}"
                            style="width: 42px; height: 42px; border-radius: 50%; object-fit: cover;">
                        {% else %}
                        {{ p.name|slice:":2"|upper }}
                        {% endif %}
                    </div>
                    <div style="min-width: 0;">
                        <p
                            style="font-weight: 600; color: {% if active_user and active_user.id == p.id %}var(--primary-color){% else %}var(--text-color){% endif %}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            {{ p.name }}</p>
                        <p style="font-size: 0.75rem; color: var(--text-muted);">{{p.research_field|default:'Researcher' }}</p>
                    </div>
                </a>
                {% endfor %}
                {% else %}
                <div style="padding: 2rem; text-align: center; color: var(--text-muted); font-size: 0.9rem;">
                    <p style="margin-bottom: 1rem;">No conversations yet.</p>
                    <a href="{% url 'index' %}" class="btn btn-outline"
                        style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">Browse Ideas to connect</a>
                </div>
                {% endif %}
        </div>
    </div>

    <!-- Chat Area -->
    <div style="display: flex; flex-direction: column;">
        {% if active_user %}
        <!-- Header -->
        <div
            style="padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; gap: 1rem;">
            <div
                style="width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; flex-shrink: 0;">
                {% if active_user.profile_pic %}
                <img src="{{ active_user.profile_pic.url }}"
                    style="width: 42px; height: 42px; border-radius: 50%; object-fit: cover;">
                {% else %}
                {{ active_user.name|slice:":2"|upper }}
                {% endif %}
            </div>
            <div>
                <p style="font-weight: 600;">{{ active_user.name }}</p>
                <p style="font-size: 0.8rem; color: var(--text-muted);">{{ active_user.institution|default:'' }} Â· {{active_user.research_field|default:'' }}</p>
            </div>
            <a href="{% url 'profile' user_id=active_user.id %}" class="btn btn-outline"
                style="margin-left: auto; padding: 0.3rem 0.7rem; font-size: 0.8rem;">View Profile</a>
        </div>

        <!-- Messages -->
        <div id="chatBox"
            style="flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem;">
            {% for msg in conversation %}
            <div
                style="display: flex; justify-content: {% if msg.sender == request.user %}flex-end{% else %}flex-start{% endif %};">
                <div
                    style="max-width: 70%; padding: 0.75rem 1rem; border-radius: {% if msg.sender == request.user %}1rem 1rem 0.25rem 1rem{% else %}1rem 1rem 1rem 0.25rem{% endif %}; background: {% if msg.sender == request.user %}linear-gradient(135deg, var(--primary-color), var(--secondary-color)){% else %}rgba(255,255,255,0.08){% endif %}; color: white;">
                    <p style="font-size: 0.95rem; word-break: break-word;">{{ msg.content }}</p>
                    <p style="font-size: 0.7rem; margin-top: 0.3rem; opacity: 0.7; text-align: right;">{{msg.timestamp|date:"H:i" }}</p>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Input -->
        <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--glass-border);">
            <form id="msgForm" style="display: flex; gap: 0.75rem; align-items: flex-end;">
                {% csrf_token %}
                <textarea id="msgInput" placeholder="Type a message..." rows="1"
                    style="flex: 1; resize: none; min-height: 44px; max-height: 120px; padding: 0.6rem 1rem; line-height: 1.5;"
                    onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMsg();}"></textarea>
                <button type="button" class="btn btn-primary" onclick="sendMsg()"
                    style="padding: 0.6rem 1.5rem; align-self: flex-end;">Send</button>
            </form>
        </div>

        <script>
            const activeUserId = {{ active_user.id }};
            let lastId = {% if conversation %}{ { conversation.last.id } } {% else %} 0{% endif %};

            function scrollToBottom() {
                const box = document.getElementById('chatBox');
                box.scrollTop = box.scrollHeight;
            }

            function addMessage(msg) {
                const box = document.getElementById('chatBox');
                const wrap = document.createElement('div');
                wrap.style.cssText = `display:flex; justify-content:${msg.mine ? 'flex-end' : 'flex-start'}`;
                wrap.innerHTML = `<div style="max-width:70%;padding:0.75rem 1rem;border-radius:${msg.mine ? '1rem 1rem 0.25rem 1rem' : '1rem 1rem 1rem 0.25rem'};background:${msg.mine ? 'linear-gradient(135deg,var(--primary-color),var(--secondary-color))' : 'rgba(255,255,255,0.08)'};color:white;">
                <p style="font-size:0.95rem;word-break:break-word;">${msg.content.replace(/</g, '&lt;')}</p>
                <p style="font-size:0.7rem;margin-top:0.3rem;opacity:0.7;text-align:right;">${msg.time}</p>
            </div>`;
                box.appendChild(wrap);
                scrollToBottom();
            }

            async function sendMsg() {
                const input = document.getElementById('msgInput');
                const content = input.value.trim();
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                if (!content) return;
                input.value = '';
                const res = await fetch('{% url "api_send_message" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ user_id: activeUserId, content })
                });
                const data = await res.json();
                addMessage({ content, mine: true, time: data.time });
                lastId = data.id;
            }

            async function pollMessages() {
                const res = await fetch(`/api/messages/${activeUserId}/?after=${lastId}`);
                const msgs = await res.json();
                msgs.forEach(m => { addMessage(m); lastId = m.id; });
            }

            scrollToBottom();
            setInterval(pollMessages, 4000);
        </script>

        {% else %}
        <!-- Empty state -->
        <div
            style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); text-align: center; padding: 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸ’¬</div>
            <h3 style="margin-bottom: 0.5rem;">Select a conversation</h3>
            <p>Choose a researcher from the left to start chatting, or message them from their profile or an idea page.
            </p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}